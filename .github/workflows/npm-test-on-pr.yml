name: Run Tests using `npm test` on PR to `main`

on:
  workflow_call: 
    inputs:
      working-directory:
        description: "The directory to run npm test in"
        required: true
        type: string
    secrets:
      GH_HTTPS_TOKEN:
        description: "GitHub token for HTTPS operations"
        required: true
  pull_request:
    branches:
      - main

jobs:
  npm-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GH_HTTPS_TOKEN }}

      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Cache Firebase Emulators
        uses: actions/cache@v3
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators
          restore-keys: |
            ${{ runner.os }}-firebase-emulators

      - name: Install Dependencies
        run: |
          echo "Current Working Directory:"
          pwd

          echo "Switching to the working directory:"
          cd ${{ inputs.working-directory || 'functions' }}

          echo "Listing all files in printed working directory:"
          ls -al

          npm install

      - name: Run Tests
        env: 
          API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
          FIRESTORE_EMULATOR_HOST: 'localhost:8080'
          FIREBASE_AUTH_EMULATOR_HOST: 'localhost:9099'
          FIREBASE_STORAGE_EMULATOR_HOST: 'localhost:9199'
          STORAGE_EMULATOR_HOST: 'http://localhost:9199'
        run: |
          echo "Switching to the working directory:"
          cd ${{ inputs.working-directory || 'functions' }}

          echo "Starting Firebase Emulators and running tests:"
          firebase emulators:exec 'npm test' --token="${{ secrets.FIREBASE_CI_TOKEN }}" --log-verbosity SILENT